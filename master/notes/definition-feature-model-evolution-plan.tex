\todo{Look at default maps}

\subsection{Feature model evolution plan}
\label{sub:feature-model-evolution-plan}
A feature model evolution plan is defined as a triple $(\names, \features, \groups)$ where \names, \features, and \groups{} are all maps.

\subsubsection{Maps}
\label{subsub:maps}

\todo{Motivate choice of data structure (mainly efficiency and modularity)}

In general, a map is a set of entries on the form $\mapping{k}{v}$. Looking up a value at the key $k$ in map \map{map} looks like this:
\[
  \lookup{\map{map}}{k}
\]

This query would give us $v$ if $\mapping{k}{v} \in \map{map}$. If we wish to assign a value $v'$ to key $k$, this is the syntax:

\[
\lookup{\map{map}}{k} \assign v'
\]

This also works if $k$ is not already in the map. We assume $O(1)$ for lookup and insertion. For maps with set values, we define an additional operator $\addassign$. If $\lookup{\map{map}}{k} = S$ then 
\[\lookup{\map{map}}{k} \addassign v = \lookup{\map{map}}{k} \assign S \cup \{v\}\]
To remove a mapping with key $k$, we use $\map{map} \setminus k$. For maps with set values, we additionally define $\removevalue{v}$, where $v$ is some value. Let $\map{map}$ be a map with set values containing the mapping $\mapping{k}{\{v\} \cup S}$. Then $\removevalue{v}$ is defined as follows:

\[
  \map{map} \removevalue{v} k =
  \begin{cases}
    \map{map} \remove k & \text{if } S = \emptyset\\
    \lookup{\map{map}}{k} \assign S & \text{if } |S| > 0
  \end{cases}
\]
That is, if removing $v$ leaves only the empty set at $\lookup{\map{map}}{k}$, we remove the mapping. Otherwise, we only remove $v$ from the set of values associated with $k$. 

\subsubsection{Intervals}
\label{subsub:intervals}
To define the map values, we must first define an interval. We use the familiar mathematical notation $\interval{t_\text{start}}{t_\text{end}}$ for the intervals, where $t_\text{start}$ and $t_\text{end}$ denote points in time. The intervals are left-closed and right-open, meaning that $t_\text{start}$ is included in the interval, and all time points until but not including $t_\text{end}$. The intervals are always used to give information about when something is true in the temporal feature model. This will be further explained in subsections \ref{subsub:mapping-names}, \ref{subsub:mapping-features}. Single time points $t_n$ may be viewed as intervals containing only the time point $t_n$

For intervals $\interval{t_{start}}{t_{end}}$ with unknown bounds, we may restrict the bounds to $t_l$ and $t_r$ by writing $\clamp{\interval{t_{start}}{t_{end}}}{t_l}{t_r}$. We then get the interval $\interval{max(t_{start}, t_l)}{min(t_{end}, t_r)}$

\subsubsection{Interval maps}
\label{subsub:interval-maps}
An interval map is a map where the key is an interval (section \vref{subsub:intervals}). To look up values, one can either give an interval or a time point as key. Both will return sets of values. For instance, if an interval map \map{i} contains the mapping $\intervalmapping{t_1}{t_5}{v}$, all of the queries in Figure \vref{ex:interval-map} will return $\{v\}$ (assuming that $t_1 < t_2 < \ldots < t_5$):

\begin{figure}[h]
  \begin{align*}
    & \lookup{\map{i}}{t_1} \\
    & \lookup{\map{i}}{t_3} \\
    & \lookup{\map{i}}{\interval{t_1}{t_5}} \\
    & \lookup{\map{i}}{\interval{t_2}{t_4}}
  \end{align*}
  \caption{Interval map example}
  \label{ex:interval-map}
\end{figure}

$\containing{\map{IM}}{t_n}$ returns the set of keys containing time point $t_n$. For interval maps with non-overlapping keys, the will contain at most one element. For interval maps with set values, we define an additional function $\containingvalue{\map{IM}}{t_n}{v}$ where $v$ is some value, returning the set of the keys containing $t_n$ and associated with a set containing $v$. 

We furthermore define function $\overlapping{\map{IM}}{t_n}{t_m}$ which returns all the interval keys in the map $\map{IM}$ overlapping the interval $\interval{t_n}{t_m}$. See section \vref{subsub:interval-sets} for definition of overlapping intervals. 

\subsubsection{Interval sets}
\label{subsub:interval-sets}
An interval set is a set of intervals with a few custom predicates and operations. Given an interval set $\map{IS}$, $\interval{t_n}{t_m} \in \map{IS}$ if $\interval{t_n}{t_m}$ is a member of the set, which is the expected semantics of $\in$. We define a similar predicate $\inn$ such that $\interval{t_n}{t_m} \inn \map{IS}$ iff there exists some interval $\interval{t_i}{t_j} \in \map{IS}$ with $t_i \leq t_n \leq t_m \leq t_j$, i.e. an interval in $\map{IS}$ which contains $\interval{t_n}{t_m}$. We further define the predicate $\innr$ such that $\interval{t_n}{t_m} \innr \map{IS}$ iff there exists some interval $\interval{t_i}{t_j} \in \map{IS}$ with $\interval{t_n}{t_m}$ overlapping $\interval{t_i}{t_j}$. Two intervals $\interval{t_n}{t_m}$ and $\interval{t_i}{t_j}$ overlap iff there exists a time point $t_k$ with $t_n \leq t_k < t_m$ and $t_i \leq t_k < t_j$, i.e. a time point contained by both intervals.

Notice that $\in \, \subseteq \, \inn \, \subseteq \, \innr$, which means that if $\interval{t_n}{t_m} \in \map{IS}$ then also $\interval{t_n}{t_m} \inn \map{IS}$, and $\interval{t_n}{t_m} \innr \map{IS}$.

$\containing{\map{IS}}{t_n}$ returns the subset of $\map{IS}$ containing $t_n$.

\subsubsection{Mapping names}
\label{subsub:mapping-names}

The \names{} map has entries of the form $\mapping{\name{}}{\textit{interval map}}$. Assuming $\mapping{\var{name}}{\map{Im}} \in \names$, the interval map \map{Im} contains mappings on the form $\intervalmapping{t_\text{start}}{t_\text{end}}{\var{featureID}}$, where \var{featureID} is the ID of some feature in the feature model evolution plan. This should be interpreted as ``\emph{The name \emph{\var{name}} belongs to the feature with ID \emph{\var{featureID}} from $t_{\emph{\text{start}}}$ to $t_{\emph{\text{end}}}$}". Looking up a name which does not exist will return an empty map $\emptyset$.

\subsubsection{Mapping features}
\label{subsub:mapping-features}

\todo{Child features/groups cannot have identical keys, change semantics}

The \features{} map has entries of the form $\mapping{\var{featureID}}{\textit{feature entry}}$. Since several pieces of information are crucial to the analysis of a feature, it is not enough to have a simple mapping as we have for names.
A feature has a name, a type, a parent group, and zero or more child groups. Furthermore, a feature may be removed and re-added during the course of the plan, so we also need information about when the feature exists.
These can all be defined in terms of intervals (\todo{rephrase}) and collected into a 5-tuple $(\map{existence} \comma \, \map{names} \comma \, \map{types} \comma \, \map{parentGroups} \comma \, \map{childGroups})$, where \map{existence} is an interval set denoting when the feature exists, \map{names} is an interval map with name values, \map{types} is a map with the feature's variation types, \map{parentGroups} is a map with group ID values, and childGroups is an interval map with group ID values, the interval keys possibly overlapping. 

Looking up a feature which does not exist returns an empty feature $(\emptyset \comma \emptyset \comma \emptyset \comma \emptyset \comma \emptyset)$. This lets us treat an unsuccessful lookup the same way as a successful one.

\subsubsection{Mapping groups}
\label{subsub:mapping-groups}

The \groups{} map has entries of the form $\mapping{\var{groupID}}{\textit{group entry}}$. A group has a type, a parent feature, and zero or more child features. It may also be removed and re-added These can all be defined in terms of intervals and collected into a 4-tuple similarly to the feature entries $(\map{existence} \comma \, \map{types}  \comma \, \map{parentFeatures} \comma \, \map{childFeatures})$, where \map{existence} is an interval set denoting when the group exists, \map{types} is a map with the group's types, \map{parentFeatures} is a map with feature IDs, and \map{childFeatures} is a map with feature ID values, the interval keys possibly overlapping.

Looking up a group which does not exist in the map returns an empty group $(\emptyset \comma \emptyset \comma \emptyset \comma \emptyset)$. 

\subsubsection{Example evolution plan}
I've created a small example (see Figure \vref{ex:washing-machine}) containing three features and one group, describing a feature model evolution plan for a washing machine. The washing machine always has a washer, and a dryer is added at $t_5$. I say that the example is small, but written out it looks huge. This is because there is a lot of redundancy, which is necessary for scoping etc. \todo{rewrite this, the language is too informal}

\begin{figure}
  \begin{align*}
    ( \{ \; & \mapping{\text{Washing Machine}}{\intervalmapping{t_0}{\forever}{0}} \\
       ,\; & \mapping{\text{Washer}}{\intervalmapping{t_0}{\forever}{1}} \\
       ,\; & \mapping{\text{Dryer}}{\intervalmapping{t_5}{\forever}{2}}\; \} \\
       \\
       ,\{\; & \mapping{0}{(\{ \interval{t_0}{\forever}\} ,\, \\
             & \{\intervalmapping{t_0}{\forever}{\text{Washing Machine}}\} ,\, \\
             & \{\intervalmapping{t_0}{\forever}{\textbf{mandatory}}\} ,\, \\
             &  \emptyset ,\, \\ 
             & \{\intervalmapping{t_0}{\forever}{10}\} ) } \\
             ,\, & \mapping{1}{(\{\interval{t_0}{\forever}\} ,\, \\
             & \{\intervalmapping{t_0}{\forever}{\text{Washer}}\} ,\, \\
             & \{\intervalmapping{t_0}{\forever}{\textbf{mandatory}}\} ,\, \\
             &  \{\intervalmapping{t_0}{\forever}{10}\} ,\, \\ 
             & \emptyset)} \\
             ,\, & \mapping{2}{(\{\interval{t_5}{\forever}\} ,\, \\
             & \{\intervalmapping{t_5}{\forever}{\text{Dryer}}\} ,\, \\
             & \{\intervalmapping{t_5}{\forever}{\textbf{optional}}\} ,\, \\
             &  \{\intervalmapping{t_5}{\forever}{10}\} ,\, \\ 
             & \emptyset)} \}\\
             \\
               ,\; \{ \; & [ 10 \mapsto (\{\interval{t_0}{\forever}\} ,\, \\
                         & \{\intervalmapping{t_0}{\forever}{\textbf{AND}}\} ,\, \\
                         & \{\intervalmapping{t_0}{\forever}{0}\} ,\, \\
                         & \{\intervalmapping{t_0}{\forever}{1},\, \intervalmapping{t_5}{\forever}{2}\} ) ]\\
    \}&)\\
  \end{align*}
  \caption{Small feature model evolution plan}
  \label{ex:washing-machine}
\end{figure}



